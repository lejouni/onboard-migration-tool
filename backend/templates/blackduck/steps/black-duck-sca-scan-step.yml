- name: Install Pip and npm requirements
  run: |
    file_count=$(find ${{github.workspace}} -name requirements.txt | wc -l)
    if [[ $file_count -gt 0 ]]; then
      pip install -r requirements.txt
    fi        
    file_count=$(find ${{github.workspace}} -name package.json | wc -l)
    if [[ $file_count -gt 0 ]]; then
      npm install
    fi        
  shell: bash
- name: Black Duck SCA Scan
  uses: blackduck-inc/black-duck-security-scan@v2
  with:
    blackduck_url: ${{ vars.BLACKDUCK_URL }}
    blackduck_api_token: ${{ secrets.BLACKDUCK_API_TOKEN }}
    blackduck_scan_full: ${{ (github.event_name == 'pull_request' && contains(fromJSON('["opened","synchronize","reopened"]'), github.event.action)) && false || true }}
    blackduck_prComment_enabled: true
    blackducksca_scan_failure_severities: 'BLOCKER,CRITICAL'
    detect_search_depth: 5
    github_token: ${{ secrets.GITHUB_TOKEN }}
  env:
    DETECT_PROJECT_NAME: ${{ github.event.repository.name }}
    DETECT_PROJECT_VERSION_NAME: ${{ github.base_ref || github.ref_name }}
    DETECT_CODE_LOCATION_NAME: ${{ github.event.repository.name }}_${{ github.ref_name }}
    DETECT_CLEANUP: "false" # This needs to be set, because of RAPID scan results
    DETECT_TIMEOUT: "7200"
    DETECT_DETECTOR_SEARCH_DEPTH: "20"
    DETECT_DETECTOR_SEARCH_CONTINUE: "true"
    DETECT_EXCLUDED_DIRECTORIES_SEARCH_DEPTH: "20"
    DETECT_EXCLUDED_DIRECTORIES: node_modules,detect,.bridge
    DETECT_PUB_DEPENDENCY_TYPES_EXCLUDE: DEV
    DETECT_NPM_DEPENDENCY_TYPES_EXCLUDED: DEV
    DETECT_TOOLS: "ALL,IAC_SCAN" #All is not activating IaC scan, it needs to be activate separately with IAC_SCAN
    DETECT_BLACKDUCK_SIGNATURE_SCANNER_COPYRIGHT_SEARCH: "true"
    DETECT_BLACKDUCK_SIGNATURE_SCANNER_LICENSE_SEARCH: "true"
    DETECT_BLACKDUCK_SIGNATURE_SCANNER_SNIPPET_MATCHING: SNIPPET_MATCHING
    DETECT_BLACKDUCK_SIGNATURE_SCANNER_UPLOAD_SOURCE_MODE: "true"
    DETECT_BLACKDUCK_RAPID_COMPARE_MODE: BOM_COMPARE_STRICT
